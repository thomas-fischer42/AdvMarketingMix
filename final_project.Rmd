---
title: "Untitled"
author: "Thomas Fischer"
date: "14 11 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("code/01_dependencies.R")
source("code/02_functions.R")
source("code/03_processing.R")
source("code/04_brandchoice.R")
source("code/05_incidence.R")
source("code/06_quantity.R")
source("code/07_combined.R")
source("code/08_segments.R")
```


```{r}
getStorePrices(kaffee) %>%
	tidyr::pivot_longer(cols = ends_with("Price"), names_to = "Brand", values_to = "Price") %>% 
	drop_duplicates() %>% 
	ggplot() + 
	geom_smooth(aes(x = Days, y = Price, group = Brand, col = Brand))
```


```{r}
getPurchaseVolume(kaffee2) %>% 
	ggplot() + 
	geom_smooth(aes(x = Days, y = Units, group = Brand, col = Brand), se = FALSE)
```




```{r}
model <- brandChoiceModel(kaffee2)
res_bch <- optim(rep(0, 11), model, return.data = FALSE, control = list(maxit = 5e2), hessian = TRUE)

res_bch$par + cbind(-qnorm(0.975) * sqrt(diag(res_bch$hessian)), 0, qnorm(0.975) * sqrt(diag(res_bch$hessian)))
kaffee3 <- model(res_bch$par, return.data = TRUE)
```

```{r}
model <- incidenceModel(kaffee3)
res_pur <- optim(rep(0, 4), model, return.data = FALSE, control = list(maxit = 5e2))

res_pur
```

```{r}
model <- quantityModel(kaffee2)
res_qty <- optim(rep(0, 12), model, return.data = FALSE, control = list(maxit = 5e2))

res_qty
```

```{r}
model <- jointModel(kaffee2)
res_full <- optim(rep(0, 27), model, control = list(maxit = 5e2))

res_full
```

```{r}
model <- jointModelSegments(kaffee2, 2)
res_seg <- optim(rep(0, 56), model)
res_seg
```

